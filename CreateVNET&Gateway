# --- Set Variables for All Commands
$vnetPrefix = '172.25.160.0/22'       # Prefix for entire vnet
$GatewaySubnet = '172.25.160.0/28'    # Gateway Subnet for the MS Routing Domain
$ProductionSubnet = '172.25.161.0/24' # Main Production Subnet
$Location = 'AustraliaEast'           # Primary Azure Location
$RGName = 'Azure-rgrp-ProdPrivate'    # Resource Group to Drop Resources Into
$vnetName = "MWH-$Location-Internal"  # VNET Name
$NGName = 'MWH-Sydney-POP'            # Name of the POP the ER's are in
$NGPrefixes =                         # MWH Prefixes (Excludinging the current vNET)
$GWIP = '159.21.128.9'                # IP Of the Primary DMZ Router in the POP
$RMPIP = "$vnetName-gwpip"            # Name of the GW IP Asssigned by MS
$RMVNGIP = "$vnetName-gwipc"          # NAme of the GW IP Configuration
$RMVNGWN = "$vnetName-vnetgw"         # Name of the vnet Gateway

# --- Define Subnets
$subnet1 = New-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -AddressPrefix $GatewaySubnet
$subnet2 = New-AzureRmVirtualNetworkSubnetConfig -Name 'Production' -AddressPrefix $ProductionSubnet

# --- Create VNET
New-AzureRmVirtualNetwork -Name $vnetName -ResourceGroupName $RGName -Location $Location -AddressPrefix $vnetPrefix -Subnet $subnet1, $subnet2
# --- Create Local Network Gateway - This is the Device that a VPN Tunnel would terminate to.
New-AzureRmLocalNetworkGateway -Name $NGName -ResourceGroupName $RGName -Location $Location -GatewayIpAddress $GWIP -AddressPrefix $NGPrefixes
# --- Create a Public IP for The Azure Side of the VPN
$gwpip= New-AzureRmPublicIpAddress -Name $RMPIP -ResourceGroupName $RGName -Location $Location -AllocationMethod Dynamic

# --- Get the information needed to connect to the ExpressRoute Circuit
$vnet = Get-AzureRmVirtualNetwork -Name $vnetName  -ResourceGroupName $RGName
$subnet = Get-AzureRmVirtualNetworkSubnetConfig -Name 'GatewaySubnet' -VirtualNetwork $vnet
$gwipconfig = New-AzureRmVirtualNetworkGatewayIpConfig -Name $RMVNGIP -SubnetId $subnet.Id -PublicIpAddressId $gwpip.Id 

New-AzureRmVirtualNetworkGateway -Name $RMVNGWN -ResourceGroupName $RGName -Location $Location -IpConfigurations $gwipconfig -GatewayType ExpressRoute -VpnType RouteBased
